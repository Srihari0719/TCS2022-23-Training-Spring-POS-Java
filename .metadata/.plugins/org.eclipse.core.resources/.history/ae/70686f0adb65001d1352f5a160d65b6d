/**
 * 
 */
package com.tcs.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Scanner;

import com.tcs.constant.SQLConstants;
import com.tcs.utils.DBUtils;

/**
 * @author Administrator
 *
 */
public class AdminDaoImp implements AdminDaoInterface{
	
	
	DBUtils cc = new DBUtils();
	Connection conn = null;
	PreparedStatement pr = null;
	Scanner sc = new Scanner(System.in);
	
	@Override
	public void approvalForStudent() {
		// TODO Auto-generated method stub
		//String sql = "SELECT username,isApproved FROM Login";
		conn = cc.connect();
		try {
			pr = conn.prepareStatement(SQLConstants.APPROVED_LOGIN);
			ResultSet rs = pr.executeQuery(SQLConstants.APPROVED_LOGIN);
			int i=0;
			while(rs.next()) {
				if(rs.getInt("isApproved")==0) {
					System.out.println(rs.getString("username"));
					String username  = rs.getString("username");
					System.out.println("1.Approve\n2.Deny");
					int n = sc.nextInt();sc.nextLine();
					i++;
					if(n == 1) {
						PreparedStatement pr1 = conn.prepareStatement("UPDATE Login SET isApproved=1 where username = '" + rs.getString("username")+ "'");
						pr1.executeUpdate();
						System.out.println("Successfully Approved..");
						pr1.close();
						continue;
					}
					else if(n == 2) {
						PreparedStatement pr1 = conn.prepareStatement("UPDATE Login SET isApproved=2 where username = '" + rs.getString("username") + "'");
						pr1.executeUpdate();
						pr1.close();
						continue;
					}
					else
						throw new NullPointerException("Please give valid input");
				}
			}
			if(i==0)
				System.out.println("No new Requests..");
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		try {
			conn.close();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

	@Override
	public void generateReportCard() {
		// TODO Auto-generated method stub
		conn = cc.connect();
		String sql1 = "SELECT DISTINCT(studentId) FROM GradeCard WHERE gradeId=6 OR gradeId=7";
		try {
			PreparedStatement pr1 = conn.prepareStatement(sql1);
			pr = conn.prepareStatement("UPDATE Student SET result='fail' WHERE Id =?");
			ResultSet rs = pr1.executeQuery(sql1);
			while(rs.next()) {
				pr.setInt(1, rs.getInt("studentId"));
				pr.executeUpdate();
			}
			PreparedStatement pr2 = conn.prepareStatement("UPDATE Student SET result='pass' WHERE result != 'fail'");
			pr2.executeUpdate();
			System.out.println("Successfully Generated..");
			pr1.close();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		try {
			conn.close();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

	@Override
	public void addCourse(int courseId,String course, String professor, int sem, float price) {
		// TODO Auto-generated method stub
		conn = cc.connect();
		String sql = "INSERT INTO Catalog Values("+ courseId +",'" + course + "','" + professor + "'," + price + "," + sem +")";
		try {
			pr = conn.prepareStatement(sql);
			pr.executeUpdate();
			System.out.println("Successfully Added.");
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		try {
			conn.close();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

	@Override
	public void addProfessor(String usernameP, String passwordP) {
		// TODO Auto-generated method stub
		conn = cc.connect();
		String sql = "INSERT INTO Login VALUES(?,?,?,?)";
		try {
			pr = conn.prepareStatement(sql);
			pr.setString(1, usernameP);
			pr.setString(2, passwordP);
			pr.setString(3, "professor");
			pr.setInt(4, 1);
			pr.executeUpdate();
			System.out.println("Successfully Added..");
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		String pName =  usernameP.substring(0, 1).toUpperCase() + usernameP.substring(1, usernameP.indexOf("@gmail.com"));
		String sql1 = "INSERT INTO Professor VALUES(?,?,?)";
		
		try {
			pr = conn.prepareStatement(sql1);
			String sql2 = "SELECT MAX(professorId) FROM Professor";
			ResultSet rs = pr.executeQuery(sql2);
			int max1 = 0;
			while(rs.next()) {
			max1 = rs.getInt(1)+1;
			}
			pr.setInt(1, max1);
			pr.setString(2, usernameP);
			pr.setString(3, pName);
			pr.executeUpdate();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		try {
			conn.close();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
	}

	@Override
	public void removeCourse(String course, String professor) {
		// TODO Auto-generated method stub
		conn = cc.connect();
		String sql = "DELETE FROM Catalog WHERE courseName='"+ course +"' AND profName='" + professor + "'";
		try {
			pr = conn.prepareStatement(sql);
			pr.executeUpdate();
			System.out.println("Successfully Removed.");
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		try {
			conn.close();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

}
